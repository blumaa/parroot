rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // =================================================================
    // SECURITY RULES - SERVER-SIDE ARCHITECTURE
    // =================================================================
    // All data access goes through Firebase Admin SDK (server-side)
    // which bypasses these security rules.
    //
    // These rules protect against direct client-side access to Firestore.
    // Since we use Next.js Server Components and Server Actions,
    // clients should NEVER directly access Firestore.
    // =================================================================

    // Helper function
    function isAuthenticated() {
      return request.auth != null;
    }

    // =================================================================
    // CONTENT COLLECTIONS
    // All content is served through Server Components and Server Actions.
    // No client-side access needed.
    // =================================================================

    match /pages/{pageId} {
      allow read, write: if false; // All access via server
    }

    match /segments/{segmentId} {
      allow read, write: if false; // All access via server
    }

    match /posts/{postId} {
      allow read, write: if false; // All access via server
    }

    match /blogPosts/{postId} {
      allow read, write: if false; // All access via server (legacy collection)
    }

    match /navigation/{navId} {
      allow read, write: if false; // All access via server
    }

    match /brandConfiguration/{configId} {
      allow read, write: if false; // All access via server
    }

    match /media/{mediaId} {
      allow read, write: if false; // All access via server
    }

    // =================================================================
    // SITE SETTINGS
    // Settings are fetched server-side and passed as props to components.
    // =================================================================

    match /settings/{settingId} {
      allow read, write: if false; // All access via server
    }

    match /siteSettings/{settingId} {
      allow read, write: if false; // All access via server (legacy collection)
    }

    // =================================================================
    // USER DATA
    // User authentication and data managed server-side through DAL.
    // =================================================================

    match /users/{userId} {
      allow read, write: if false; // All access via server
    }

    // =================================================================
    // FORM SUBMISSIONS
    // EXCEPTION: Public can CREATE form submissions (contact forms, etc.)
    // All other operations (read/update/delete) are server-side only.
    // =================================================================

    match /formSubmissions/{submissionId} {
      allow create: if true; // Public can submit forms
      allow read, update, delete: if false; // All access via server
    }

    // =================================================================
    // DEFAULT DENY
    // Deny all other collections by default.
    // =================================================================

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
